<?plantuml 1.2026.1beta5?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="818px" preserveAspectRatio="none" style="width:1087px;height:818px;background:#FFFFFF;" version="1.1" viewBox="0 0 1087 818" width="1087px" zoomAndPan="magnify"><title>ACP Protocol - Session Mode Switching</title><defs/><g><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="484.9668" x="299.6855" y="35.4209">ACP Protocol - Session Mode Switching</text><g class="participant-lifeline" data-entity-uid="part1" data-qualified-name="C" id="part1-lifeline"><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="699.9844" width="8" x="505.2651" y="82.9063"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="509" x2="509" y1="82.9063" y2="782.8906"/></g></g><g class="participant-lifeline" data-entity-uid="part2" data-qualified-name="A" id="part2-lifeline"><g><title>Agent</title><rect fill="#000000" fill-opacity="0.00000" height="699.9844" width="8" x="730.543" y="82.9063"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="733.8232" x2="733.8232" y1="82.9063" y2="782.8906"/></g></g><g class="participant-lifeline" data-entity-uid="part3" data-qualified-name="L" id="part3-lifeline"><g><title>LLM</title><rect fill="#000000" fill-opacity="0.00000" height="699.9844" width="8" x="1040.4985" y="82.9063"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1043.6592" x2="1043.6592" y1="82.9063" y2="782.8906"/></g></g><g class="participant participant-head" data-entity-uid="part1" data-qualified-name="C" id="part1-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="54.5303" x="482" y="51.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="489" y="71.6045">Client</text></g><g class="participant participant-tail" data-entity-uid="part1" data-qualified-name="C" id="part1-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="54.5303" x="482" y="781.8906"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="489" y="801.8857">Client</text></g><g class="participant participant-head" data-entity-uid="part2" data-qualified-name="A" id="part2-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="55.4395" x="706.8232" y="51.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="713.8232" y="71.6045">Agent</text></g><g class="participant participant-tail" data-entity-uid="part2" data-qualified-name="A" id="part2-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="55.4395" x="706.8232" y="781.8906"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="713.8232" y="801.8857">Agent</text></g><g class="participant participant-head" data-entity-uid="part3" data-qualified-name="L" id="part3-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="41.6787" x="1023.6592" y="51.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="27.6787" x="1030.6592" y="71.6045">LLM</text></g><g class="participant participant-tail" data-entity-uid="part3" data-qualified-name="L" id="part3-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="41.6787" x="1023.6592" y="781.8906"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="27.6787" x="1030.6592" y="801.8857">LLM</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1075.3379" x="5" y="113.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1080.3379" y1="113.4727" y2="113.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1080.3379" y1="116.4727" y2="116.4727"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="171.168" x="457.085" y="102.9063"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="152.6421" x="463.085" y="118.9731">Mode Advertisement</text><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg1"><polygon fill="#000000" points="722.543,153.1719,732.543,157.1719,722.543,161.1719,726.543,157.1719" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="509.2651" x2="728.543" y1="157.1719" y2="157.1719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.2778" x="516.2651" y="152.106">session/new(cwd, mcpServers)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg2"><polygon fill="#000000" points="520.2651,260.9688,510.2651,264.9688,520.2651,268.9688,516.2651,264.9688" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="514.2651" x2="733.543" y1="264.9688" y2="264.9688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="140.9751" x="526.2651" y="259.9028">NewSessionResponse</text></g><path d="M10,170.1719 L10,346.1719 L504,346.1719 L504,180.1719 L494,170.1719 L10,170.1719" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M494,170.1719 L494,180.1719 L504,180.1719 L494,170.1719" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="16" y="187.2388">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="179.7656" x="24.2646" y="202.3716">"sessionId": "sess_abc123",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100.02" x="24.2646" y="217.5044">"modeState": {</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177.2583" x="32.5293" y="232.6372">"currentModeId": "normal",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="126.4136" x="32.5293" y="247.77">"availableModes": [</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="448.9189" x="40.7939" y="262.9028">{"id": "normal", "name": "Normal", "description": "Standard mode"},</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="429.5903" x="40.7939" y="278.0356">{"id": "plan", "name": "Plan", "description": "Plan before acting"},</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="444.1138" x="40.7939" y="293.1685">{"id": "architect", "name": "Architect", "description": "Design only"}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="5.0718" x="32.5293" y="308.3013">]</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="24.2646" y="323.4341">}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="16" y="338.5669">}</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1075.3379" x="5" y="372.1992"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1080.3379" y1="372.1992" y2="372.1992"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1080.3379" y1="375.1992" y2="375.1992"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="182.5176" x="451.4102" y="361.6328"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163.9917" x="457.4102" y="377.6997">Client-Initiated Switch</text><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg4"><polygon fill="#000000" points="722.543,437.5977,732.543,441.5977,722.543,445.5977,726.543,441.5977" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="509.2651" x2="728.543" y1="441.5977" y2="441.5977"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115.7368" x="516.2651" y="436.5317">session/set_mode</text></g><path d="M739,399.7656 L739,469.7656 L948,469.7656 L948,409.7656 L938,399.7656 L739,399.7656" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M938,399.7656 L938,409.7656 L948,409.7656 L938,399.7656" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="745" y="416.8325">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="179.7656" x="753.2646" y="431.9653">"sessionId": "sess_abc123",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="109.4526" x="753.2646" y="447.0981">"modeId": "plan"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="745" y="462.231">}</text><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg6"><polygon fill="#000000" points="520.2651,495.4297,510.2651,499.4297,520.2651,503.4297,516.2651,499.4297" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="514.2651" x2="733.543" y1="499.4297" y2="499.4297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="119.7866" x="526.2651" y="494.3638">SetModeResponse</text></g><path d="M324,480.2969 L324,505.2969 L503,505.2969 L503,490.2969 L493,480.2969 L324,480.2969" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M493,480.2969 L493,490.2969 L503,490.2969 L493,480.2969" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="158.647" x="330" y="497.3638">Mode switched to "plan"</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1075.3379" x="5" y="530.9961"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1080.3379" y1="530.9961" y2="530.9961"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1080.3379" y1="533.9961" y2="533.9961"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="183.4316" x="450.9531" y="520.4297"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="164.9058" x="456.9531" y="536.4966">Agent-Initiated Switch</text><g class="message" data-entity-1="part2" data-entity-2="part3" id="msg8"><polygon fill="#000000" points="1032.4985,570.6953,1042.4985,574.6953,1032.4985,578.6953,1036.4985,574.6953" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="734.543" x2="1038.4985" y1="574.6953" y2="574.6953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="285.9556" x="741.543" y="569.6294">Planning complete, request implementation</text></g><g class="message" data-entity-1="part3" data-entity-2="part2" id="msg9"><polygon fill="#000000" points="745.543,599.8281,735.543,603.8281,745.543,607.8281,741.543,603.8281" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="739.543" x2="1043.4985" y1="603.8281" y2="603.8281"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="171.4438" x="751.543" y="598.7622">Call "exit_plan_mode" tool</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg10"><polygon fill="#000000" points="520.2651,654.6602,510.2651,658.6602,520.2651,662.6602,516.2651,658.6602" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="514.2651" x2="733.543" y1="658.6602" y2="658.6602"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="98.3062" x="526.2651" y="653.5942">session/update</text></g><path d="M739,616.8281 L739,686.8281 L1043,686.8281 L1043,626.8281 L1033,616.8281 L739,616.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1033,616.8281 L1033,626.8281 L1043,626.8281 L1033,616.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="745" y="633.895">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="274.8472" x="753.2646" y="649.0278">"sessionUpdate": "current_mode_update",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="127.1626" x="753.2646" y="664.1606">"modeId": "normal"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="745" y="679.2935">}</text><path d="M461,697.3594 L461,767.3594 L782,767.3594 L782,707.3594 L772,697.3594 L461,697.3594" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M772,697.3594 L772,707.3594 L782,707.3594 L772,697.3594" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="110.7031" x="467" y="714.4263">Common modes:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="274.2759" x="467" y="729.5591">- Ask: Request permission before changes</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="300.2061" x="467" y="744.6919">- Plan/Architect: Design without implementing</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.8872" x="467" y="759.8247">- Code/Normal: Full tool access</text><?plantuml-src ZLJ1Yjim4BthAwO-jP0GsjuCAHYNGY2xX0qzbH8KUJOHbILNccnQblnxPsHlDixkGYyXcXczUVFcoUzeZor2vxJrIf4bXr3LArZ5GC441rDOOqesUBW93SBwQCdihTyfrUb8rjXEUuAYTXOz5Q0JrEDCjNjALEF4SdcJmqkbvlCUlMeUa2iIK-AA-Lof6gPVe88IKizYvl7utXoR2RIcMsFa-lH1LJ3bifhBRl4uyBt3r0MVKFb020xlIJqgW680MZH5sHysUci-VlfSJ2JRCeqrQKBEIZc7p256fYC4-qi-n5QxNCzf_Q2jqrk7Kf0u_oF70HuBEohdVxeLtEBs7E4R9jgEc90akBDlT6n0Q1IdoHKIRybVugo6ynMAX66Bzo4YQ4Eyh9TGEl8M2GrTubMNmIlGhvZipaFmxcznoc0_-VUaJWfz0w9nNcFlW-d2MxAiOZCOvlLT9gIDJDglADhT_hztj7WMP4JXsGbhp2jxQOEozrhAn9WXXISW6I3RzNN-bV1VChG8x5bMCA7j719E8EBl0oO2Am5nhnRXr3BJaPbhxHmK-CVIHfhbkGlk7Tm0N5y8S-WQRlwMBDzpLkOVh9d1DlsbQua6zur4ohY1dmvK4twk07LeMtxXSYkLV9v2bNwLS3SCrM5iRVyH66nbzjhlCELIKMDsjau9WrDOjtquN2WY7msfhxdBh7y29Nmxi2oY0ZlLy7Xdbly0?></g></svg>