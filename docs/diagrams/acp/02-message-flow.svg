<?plantuml 1.2026.1beta5?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="876px" preserveAspectRatio="none" style="width:823px;height:876px;background:#FFFFFF;" version="1.1" viewBox="0 0 823 876" width="823px" zoomAndPan="magnify"><title>ACP Protocol - Complete Message Flow</title><defs/><g><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="484.4941" x="168.1072" y="35.4209">ACP Protocol - Complete Message Flow</text><g><title>Agent</title><rect fill="#FFFFFF" height="355.5938" style="stroke:#000000;stroke-width:1;" width="10" x="532.5933" y="389.1016"/></g><g><title>LLM</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#000000;stroke-width:1;" width="10" x="679.5879" y="418.2344"/></g><rect fill="#FFFFFF" height="46.2656" style="stroke:#000000;stroke-width:1;" width="560.313" x="25" y="462.3672"/><rect fill="#FFFFFF" height="193.9297" style="stroke:#000000;stroke-width:1;" width="580.313" x="15" y="522.6328"/><rect fill="#FFFFFF" height="75.3984" style="stroke:#000000;stroke-width:1;" width="560.313" x="25" y="575.8984"/><g class="participant-lifeline" data-entity-uid="part1" data-qualified-name="C" id="part1-lifeline"><g><title>Client .IDE.</title><rect fill="#000000" fill-opacity="0.00000" height="758.0547" width="8" x="87.8296" y="82.9063"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="91" x2="91" y1="82.9063" y2="840.9609"/></g></g><g class="participant-lifeline" data-entity-uid="part2" data-qualified-name="A" id="part2-lifeline"><g><title>Agent</title><rect fill="#000000" fill-opacity="0.00000" height="758.0547" width="8" x="533.5933" y="82.9063"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="536.8735" x2="536.8735" y1="82.9063" y2="840.9609"/></g></g><g class="participant-lifeline" data-entity-uid="part3" data-qualified-name="L" id="part3-lifeline"><g><title>LLM</title><rect fill="#000000" fill-opacity="0.00000" height="758.0547" width="8" x="680.5879" y="82.9063"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="683.7485" x2="683.7485" y1="82.9063" y2="840.9609"/></g></g><g class="participant participant-head" data-entity-uid="part1" data-qualified-name="C" id="part1-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="93.6592" x="45" y="51.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="79.6592" x="52" y="71.6045">Client (IDE)</text></g><g class="participant participant-tail" data-entity-uid="part1" data-qualified-name="C" id="part1-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="93.6592" x="45" y="839.9609"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="79.6592" x="52" y="859.9561">Client (IDE)</text></g><g class="participant participant-head" data-entity-uid="part2" data-qualified-name="A" id="part2-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="55.4395" x="509.8735" y="51.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="516.8735" y="71.6045">Agent</text></g><g class="participant participant-tail" data-entity-uid="part2" data-qualified-name="A" id="part2-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="55.4395" x="509.8735" y="839.9609"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="516.8735" y="859.9561">Agent</text></g><g class="participant participant-head" data-entity-uid="part3" data-qualified-name="L" id="part3-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="41.6787" x="663.7485" y="51.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="27.6787" x="670.7485" y="71.6045">LLM</text></g><g class="participant participant-tail" data-entity-uid="part3" data-qualified-name="L" id="part3-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="41.6787" x="663.7485" y="839.9609"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="27.6787" x="670.7485" y="859.9561">LLM</text></g><g><title>Agent</title><rect fill="#FFFFFF" height="355.5938" style="stroke:#000000;stroke-width:1;" width="10" x="532.5933" y="389.1016"/></g><g><title>LLM</title><rect fill="#FFFFFF" height="29.1328" style="stroke:#000000;stroke-width:1;" width="10" x="679.5879" y="418.2344"/></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="811.7085" x="5" y="113.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="113.4727" y2="113.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="116.4727" y2="116.4727"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="159.2598" x="331.2244" y="102.9063"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="140.7339" x="337.2244" y="118.9731">Initialization Phase</text><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg1"><polygon fill="#000000" points="525.5933,153.1719,535.5933,157.1719,525.5933,161.1719,529.5933,157.1719" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="91.8296" x2="531.5933" y1="157.1719" y2="157.1719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="354.8276" x="98.8296" y="152.106">initialize(protocolVersion, clientCapabilities, clientInfo)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg2"><polygon fill="#000000" points="102.8296,182.3047,92.8296,186.3047,102.8296,190.3047,98.8296,186.3047" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="96.8296" x2="536.5933" y1="186.3047" y2="186.3047"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="421.7637" x="108.8296" y="181.2388">InitializeResponse(protocolVersion, agentCapabilities, agentInfo)</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="811.7085" x="5" y="214.8711"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="214.8711" y2="214.8711"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="217.8711" y2="217.8711"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="141.7466" x="339.981" y="204.3047"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="123.2207" x="345.981" y="220.3716">Session Creation</text><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg3"><polygon fill="#000000" points="525.5933,254.5703,535.5933,258.5703,525.5933,262.5703,529.5933,258.5703" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="91.8296" x2="531.5933" y1="258.5703" y2="258.5703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.2778" x="98.8296" y="253.5044">session/new(cwd, mcpServers)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg4"><polygon fill="#000000" points="102.8296,283.7031,92.8296,287.7031,102.8296,291.7031,98.8296,287.7031" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="96.8296" x2="536.5933" y1="287.7031" y2="287.7031"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="318.7476" x="108.8296" y="282.6372">NewSessionResponse(sessionId, models, modes)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg5"><polygon fill="#000000" points="102.8296,312.8359,92.8296,316.8359,102.8296,320.8359,98.8296,316.8359" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="96.8296" x2="536.5933" y1="316.8359" y2="316.8359"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="297.5908" x="108.8296" y="311.77">session/update(available_commands_update)</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="811.7085" x="5" y="345.4023"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="345.4023" y2="345.4023"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="348.4023" y2="348.4023"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="110.7764" x="355.4661" y="334.8359"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="92.2505" x="361.4661" y="350.9028">Prompt Turn</text><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg6"><polygon fill="#000000" points="520.5933,385.1016,530.5933,389.1016,520.5933,393.1016,524.5933,389.1016" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="91.8296" x2="526.5933" y1="389.1016" y2="389.1016"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="236.3867" x="98.8296" y="384.0356">session/prompt(sessionId, prompt[])</text></g><g class="message" data-entity-1="part2" data-entity-2="part3" id="msg7"><polygon fill="#000000" points="667.5879,414.2344,677.5879,418.2344,667.5879,422.2344,671.5879,418.2344" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="542.5933" x2="673.5879" y1="418.2344" y2="418.2344"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="93.1328" x="549.5933" y="413.1685">Submit to LLM</text></g><g class="message" data-entity-1="part3" data-entity-2="part2" id="msg8"><polygon fill="#000000" points="553.5933,443.3672,543.5933,447.3672,553.5933,451.3672,549.5933,447.3672" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="547.5933" x2="683.5879" y1="447.3672" y2="447.3672"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="112.9946" x="559.5933" y="442.3013">Response stream</text></g><path d="M25,462.3672 L101.624,462.3672 L101.624,469.5 L91.624,479.5 L25,479.5 L25,462.3672" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:1;" width="560.313" x="25" y="462.3672"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="31.624" x="40" y="475.4341">loop</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="104.7739" x="116.624" y="474.5776">[For each chunk]</text><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg9"><polygon fill="#000000" points="102.8296,496.6328,92.8296,500.6328,102.8296,504.6328,98.8296,500.6328" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="96.8296" x2="531.5933" y1="500.6328" y2="500.6328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="295.6167" x="108.8296" y="495.5669">session/update(agent_message_text_update)</text></g><path d="M15,522.6328 L84.4512,522.6328 L84.4512,529.7656 L74.4512,539.7656 L15,539.7656 L15,522.6328" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="193.9297" style="stroke:#000000;stroke-width:1;" width="580.313" x="15" y="522.6328"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="24.4512" x="30" y="535.6997">opt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="101.1108" x="99.4512" y="534.8433">[Tool Execution]</text><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg10"><polygon fill="#000000" points="102.8296,556.8984,92.8296,560.8984,102.8296,564.8984,98.8296,560.8984" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="96.8296" x2="531.5933" y1="560.8984" y2="560.8984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="275.5645" x="108.8296" y="555.8325">session/update(tool_call_update: pending)</text></g><path d="M25,575.8984 L89.4429,575.8984 L89.4429,583.0313 L79.4429,593.0313 L25,593.0313 L25,575.8984" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="75.3984" style="stroke:#000000;stroke-width:1;" width="560.313" x="25" y="575.8984"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="40" y="588.9653">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="137.1563" x="104.4429" y="588.1089">[Requires Permission]</text><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg11"><polygon fill="#000000" points="102.8296,610.1641,92.8296,614.1641,102.8296,618.1641,98.8296,614.1641" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="96.8296" x2="531.5933" y1="614.1641" y2="614.1641"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="295.0962" x="108.8296" y="609.0981">session/request_permission(toolCall, options)</text></g><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg12"><polygon fill="#000000" points="520.5933,639.2969,530.5933,643.2969,520.5933,647.2969,524.5933,643.2969" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="91.8296" x2="526.5933" y1="643.2969" y2="643.2969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="197.1646" x="98.8296" y="638.231">PermissionResponse(optionId)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg13"><polygon fill="#000000" points="102.8296,675.4297,92.8296,679.4297,102.8296,683.4297,98.8296,679.4297" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="96.8296" x2="531.5933" y1="679.4297" y2="679.4297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="297.7622" x="108.8296" y="674.3638">session/update(tool_call_update: in_progress)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg14"><polygon fill="#000000" points="102.8296,704.5625,92.8296,708.5625,102.8296,712.5625,98.8296,708.5625" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="96.8296" x2="531.5933" y1="708.5625" y2="708.5625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="291.6938" x="108.8296" y="703.4966">session/update(tool_call_update: completed)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg15"><polygon fill="#000000" points="102.8296,740.6953,92.8296,744.6953,102.8296,748.6953,98.8296,744.6953" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="96.8296" x2="536.5933" y1="744.6953" y2="744.6953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="265.5859" x="108.8296" y="739.6294">PromptResponse(stop_reason: end_turn)</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="811.7085" x="5" y="773.2617"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="773.2617" y2="773.2617"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="816.7085" y1="776.2617" y2="776.2617"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1;" width="109.1577" x="356.2754" y="762.6953"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90.6318" x="362.2754" y="778.7622">Cancellation</text><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg16"><polygon fill="#000000" points="525.5933,815.9609,535.5933,819.9609,525.5933,823.9609,529.5933,819.9609" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="91.8296" x2="531.5933" y1="819.9609" y2="819.9609"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="164.9629" x="98.8296" y="814.895">session/cancel(sessionId)</text></g><path d="M542,800.8281 L542,825.8281 L806,825.8281 L806,810.8281 L796,800.8281 L542,800.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M796,800.8281 L796,810.8281 L806,810.8281 L796,800.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="243.1152" x="548" y="817.895">Agent returns stop_reason: cancelled</text><?plantuml-src bLHDYzim4BthLqptb412xu4KZBiB0My9JUcb5AF8KqTKbbHfd2pzzHrBZfEmsTAU33FllNdp8R-Z0tO8taXjXI1D1g4ejx0DZfno1fPGkiuR98HdZ56s24_6dOJmCf1MsajBy50QZVoTRJu-pXz0HYXlyqNBwPGeRXDLzPp2bH3hDMoi9YsD_Yr9EmlRWum8wxKeOVa12bY1FWDmvaU7Np541Yz09G-bz7Al3SCmdcCR-yFDHG5BLYbPPIg3dp5wP-CTDTc-4akXh3MOtV4u1fTbm6ptscZCoVSMJpDrQXRGAR_3S6JvQoUVy3JAJ4v6vcRWk0PDpDzCowopUEyRIJYJHwcDt1kibUiwQPjOvqpsoQliFC6NFjotw5F-kcwEVFi-5rAHFh8IhosNhvYuw_UT9Y07lBqBf19LwclGFdS3aNWwdMZm2YQCSnwUN02E7a0TUljJ0BpPtZ3skil7LnE-qDGUsaO8DpJd-5GVNr3rmoR-8aOCh9KqPjHOWMSHRLkU5O0qnDP_zJfWX2s6JYSoP-ue1WPYfDfFkAHUilW2s1G7U6a3jPpcSj6SzfsHcsQ0fdx-nxosDI-hPRkfrByJrVYect68bvFCvt8vHtA-vXr6PrU3lvhuZkRN2otIbPNIAZJcxPUW4k1oPdDX7RE3RW-qWlI3W823UeIRefbeiFa3?></g></svg>